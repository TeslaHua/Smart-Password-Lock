C51 COMPILER V9.02   DS1302                                                                12/19/2015 20:58:46 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\DS1302.obj
COMPILER INVOKED BY: E:\KEIL C51\C51\BIN\C51.EXE ..\SOURCE\DS1302.c BROWSE INCDIR(..\HEADER) DEBUG OBJECTEXTEND PRINT(.\
                    -DS1302.lst) OBJECT(.\DS1302.obj)

line level    source

   1          #include"DS1302.h"
   2          
   3          uchar second=0,minute=0,hour=0;  //需要转换的时分秒
   4          uchar day=0,month=0,year=0;        //需要转换的年月日
   5          uchar temp=0;           //直接读到的DS1302的数值，还要做转换
   6          
   7          /*******************************************************************************
   8          * 函 数 名         : Delay(uchar z)
   9          * 函数功能                 : 延时
  10          * 输    入         : uchar z
  11          * 输    出         : 无
  12          *******************************************************************************/
  13          void Delay1302(uint z)
  14          {
  15   1              uint a,b;
  16   1              for(a=z;a>0;a--)
  17   1                      for(b=110;b>0;b--);
  18   1      }
  19          
  20          
  21          /*******************************************************************************
  22          * 函 数 名         : Ds1302init()
  23          * 函数功能                 : Ds1302初始化
  24          * 输    入         : 无
  25          * 输    出         : 无
  26          *******************************************************************************/
  27          void Ds1302init()                       //初始化函数
  28          {       
  29   1              Write1302(0x8e,0x00);           //取消写保护            
  30   1          Write1302(0x80,((30/10)<<4|(30%10)));    //1302上的时间初始化，并且将十进制数转换成BCD码
  31   1              Write1302(0x82,((55/10)<<4|(55%10)));
  32   1          Write1302(0x84,((19/10)<<4|(19%10)));
  33   1          Write1302(0x86,((19/10)<<4|(19%10)));
  34   1          Write1302(0x88,((12/10)<<4|(12%10)));
  35   1          Write1302(0x8c,((15/10)<<4|(15%10)));    
  36   1              Write1302(0x80,0x00);       //打开1302 的震荡，使其走字
  37   1              Write1302(0x8e,0x80);       //写入写保护
  38   1      }
  39          
  40          
  41          /*******************************************************************************
  42          * 函 数 名         :  Write1602sfm
  43          * 函数功能                 : 在1602上面刷新DS1302的时分秒
  44          * 输    入         : add,液晶显示初始位置，data日期数据
  45          * 输    出         : 无
  46          *******************************************************************************/
  47          void Write1602sfm(uchar add,char date)          //1602刷新时分秒
  48          {
  49   1              char shi,ge;
  50   1              shi=date/10;
  51   1              ge=date%10;
  52   1              lcdwritecom(0x80+0x40+add);
  53   1              lcdwritedate(0x30+shi);
  54   1              lcdwritedate(0x30+ge);
C51 COMPILER V9.02   DS1302                                                                12/19/2015 20:58:46 PAGE 2   

  55   1      }
  56          
  57          /*******************************************************************************
  58          * 函 数 名         : Write1602nyr
  59          * 函数功能                 : 在1602上面刷新DS1302的年月日
  60          * 输    入         : add,液晶显示初始位置，data日期数据
  61          * 输    出         : 无
  62          *******************************************************************************/
  63          void Write1602nyr(uchar add,char date)          //1602刷新年月日
  64          {
  65   1              char shi,ge;
  66   1              shi=date/10;
  67   1              ge=date%10;
  68   1              lcdwritecom(0x80+add+3);
  69   1              lcdwritedate(0x30+shi);
  70   1              lcdwritedate(0x30+ge);
  71   1      }
  72          
  73          
  74          /*******************************************************************************
  75          * 函 数 名         : Write1302
  76          * 函数功能                 : 往ds1302里面写数据
  77          * 输    入         : add,8位地址命令，data为8位数据
  78          * 输    出         : 无
  79          *******************************************************************************/
  80          void Write1302(uchar addr, uchar dat)
  81          {
  82   1              uchar n;
  83   1              RST=0;
  84   1              _nop_();
  85   1              DSIO=0;//先将SCLK置低电平。
  86   1              _nop_();
  87   1              RST=1; //然后将RST(CE)置高电平。
  88   1              _nop_();
  89   1              for(n=0; n<8; n++)//开始传送八位地址命令
  90   1              {
  91   2                      DSIO=addr&0x01;//数据从低位开始传送
  92   2                      addr >>= 1;
  93   2                      SCLK = 1;//数据在上升沿时，DS1302读取数据
  94   2                      _nop_();
  95   2                      SCLK = 0;
  96   2                      _nop_();
  97   2              }
  98   1              for (n=0; n<8; n++)//写入8位数据
  99   1              {
 100   2                      DSIO= dat & 0x01;
 101   2                      dat >>= 1;
 102   2                      SCLK = 1;//数据在上升沿时，DS1302读取数据
 103   2                      _nop_();
 104   2                      SCLK = 0;
 105   2                      _nop_();        
 106   2              }       
 107   1                       
 108   1              RST = 0;//传送数据结束
 109   1              _nop_();
 110   1      }
 111          
 112          
 113          /*******************************************************************************
 114          * 函 数 名         : Read1302
 115          * 函数功能                 : 从ds1302里面读出8位数据
 116          * 输    入         : add,8位地址命令
C51 COMPILER V9.02   DS1302                                                                12/19/2015 20:58:46 PAGE 3   

 117          * 输    出         : dat,8位的数据
 118          *******************************************************************************/
 119          uchar Read1302(uchar addr)
 120          {
 121   1              uchar n,dat,dat1;
 122   1              RST = 0;
 123   1              _nop_();
 124   1      
 125   1      
 126   1              SCLK = 0;//先将SCLK置低电平。
 127   1              _nop_();
 128   1              RST = 1;//然后将RST(CE)置高电平。
 129   1              _nop_();
 130   1      
 131   1      
 132   1              for(n=0; n<8; n++)//开始传送八位地址命令
 133   1              {
 134   2                      DSIO = addr & 0x01;//数据从低位开始传送
 135   2                      addr >>= 1;
 136   2                      SCLK = 1;//数据在上升沿时，DS1302读取数据
 137   2                      _nop_();
 138   2                      SCLK = 0;//DS1302下降沿时，放置数据
 139   2                      _nop_();
 140   2              }
 141   1              _nop_();
 142   1              for(n=0; n<8; n++)//读取8位数据
 143   1              {
 144   2                      dat1 = DSIO;//从最低位开始接收
 145   2                      dat = (dat>>1) | (dat1<<7);
 146   2                      SCLK = 1;
 147   2                      _nop_();
 148   2                      SCLK = 0;//DS1302下降沿时，放置数据
 149   2                      _nop_();
 150   2              }
 151   1      
 152   1      
 153   1              RST = 0;
 154   1              _nop_();        //以下为DS1302复位的稳定时间,必须的。
 155   1              SCLK = 1;
 156   1              _nop_();
 157   1              DSIO = 0;
 158   1              _nop_();
 159   1              DSIO = 1;
 160   1              _nop_();
 161   1              return dat;     
 162   1      }
 163          
 164          
 165          /*******************************************************************************
 166          * 函 数 名         : Transformation()
 167          * 函数功能                 : 把从ds1302里面读出8位数据转换成供1602显示的数据
 168          * 输    入         : 无
 169          * 输    出         : 无
 170          *******************************************************************************/
 171          void Transformation()                   //把从DS1302中读取的数装换为需要的数给LCD1602显示
 172          {
 173   1              temp=Read1302(0x81);
 174   1              second=((temp&0x70)>>4)*10+(temp&0x0f);         //将BCD码换成十进制个给1602显示
 175   1              Write1602sfm(10,second);
 176   1              temp=Read1302(0x83);
 177   1              minute=((temp&0x70)>>4)*10+(temp&0x0f);
 178   1              Write1602sfm(7,minute);
C51 COMPILER V9.02   DS1302                                                                12/19/2015 20:58:46 PAGE 4   

 179   1              temp=Read1302(0x85);
 180   1              hour=((temp&0x70)>>4)*10+(temp&0x0f);
 181   1              Write1602sfm(4,hour);
 182   1              temp=Read1302(0x87);
 183   1              day=((temp&0x70)>>4)*10+(temp&0x0f);
 184   1              Write1602nyr(8,day);
 185   1              temp=Read1302(0x89);
 186   1              month=((temp&0x70)>>4)*10+(temp&0x0f);
 187   1              Write1602nyr(5,month);
 188   1              temp=Read1302(0x8d);
 189   1              year=((temp&0xf0)>>4)*10+(temp&0x0f);
 190   1              Write1602nyr(2,year);
 191   1      }
 192          
 193          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    496    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
